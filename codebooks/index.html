<!DOCTYPE html>
<html lang="en" class=" is-copy-enabled">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Area for data dissemination from the Survey of the Health of Wisconsin (SHOW).">
    <meta name="author" content="Survey of the Health of Wisconsin">


    <title>SHOW Data</title>


    <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="GitHub">

    <!-- Icons -->
    <link rel="fluid-icon" href="" title="SHOW">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-144.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144.png">
    <meta name="msapplication-TileImage" content="/windows-tile.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="selected-link" value="repo_source" data-pjax-transient>
    <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">

    <!-- jQuery -->
    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    
    <!-- Bootstrap -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/>

    <!-- CDN fallbacks to local copies -->
    <script>
      if (!window.jQuery) {
        document.write('<script src="./js/jquery-2.1.4.min.js"><\/script>')
      } else {
        var bootstrap_css = false;
        $.each(document.styleSheets, function(i,sheet){
          // alert(sheet.href)
          var pat = new RegExp("maxcdn\.bootstrapcdn\.com/.+/bootstrap.+\.css");
          if (pat.test(sheet.href)) {
            bootstrap_css = true;
          }
        });
        if (!bootstrap_css) {
          $('<link rel="stylesheet" type="text/css" href="./css/bootstrap.min.js" />').appendTo('head');
        }
      }
      
      if (!window.jQuery.fn.modal) {
        document.write('<script src="/js/bootstrap.min.js"><\/script>');
      }
    </script>

    <style type="text/css">
      body {
        
      }
      .container-fluid{
        
      }
      .full-page{
        position: fixed;
        top: 50px;
        left: 0;
        right: 0;
        bottom: 0;
        height: auto;
        width: 100%;
      }
      .row-fill{
        position: relative;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        height: 100%;
        width: inherit;
        overflow: auto;
      }
      .col-fixed-1{
          position: fixed;
          top: 50px;
          left: 0;
          right: 0;
          bottom: 0;
          width: 300px;
          height: inherit;
          background:lightblue;
          overflow-y: scroll;
          overflow-x: hidden;
      }
      .col-fixed-2{
          position: fixed;
          top: 50px;
          left: 300px;
          right: 0;
          bottom: 0;
          width: 300px;
          height: inherit;
          background:lightgray;
          overflow-y: scroll;
          overflow-x: hidden;
      }
      .col-fixed-3{
          position: fixed;
          top: 50px;
          left: 600px;
          right: 0;
          bottom: 0;
          height: inherit;
          overflow: hidden;
          padding: 5px;
      }
      .embed-full{
        height: 100%;
        overflow: auto;
      }
      #codebook-iframe{
        height: 98%;
        width: inherit;
      }
      .list-group-item.codebook-list-year-header {
        font-weight: bold;
        background-color: lightblue;
        margin-top: 5px;
      }
      #codebook-list a.list-group-item {
        margin-left: 5px;
      }
    </style>
  </head>
  <body id="page-top" class="index">

    <header>
      <nav role="navigation" class="navbar navbar-sm navbar-default navbar-fixed-top">

        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <span class="navbar-brand">SHOW Data Dissemination</span>
        </div>

        <!-- Collection of nav links and other content for toggling -->
        <div id="navbarCollapse" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class=""><a href="#">Home</a></li>
            <li class=""><a href="#">Charts</a></li>
            <li class=""><a href="#">Codebooks</a></li>
            <li class=""><a href="#">Documentation</a></li>
            <li class=""><a href="#">Contact</a></li>
          </ul>
        </div>
      </nav>

    </header>



    <div class="container-fluid">
    <div class="row full-page" >
      <div class="col-fixed-1">
        <ul id="instrument-list">
        </ul>
      </div>
      <div class="col-fixed-2">
        <div id="codebook-list" class="list-group">
        </div>
      </div>
      <div class="col-fixed-3">
          <div class="row row-fill">
            <div class="col-xs-12 embed-full">
              <iframe id="codebook-iframe">Your browser does not support iFrames.</iframe>
            </div>
          </div>
      </div>
    </div>
    </div>

  <script type="text/javascript">
    $(document).ready( function() {
      // console.log('hello world');

      // functions
      var instrumentClicked = function(e) 
      {
        // console.log('function ready');
        e.preventDefault();
        var cb = $(this).data("codebooks");
         // console.log(cb);
        var tg = $('#codebook-list');
         // console.log(tg);
        tg.empty();

        parseInstrument(cb, tg);
      }

      var codebookClicked = function(e)
      {
        // console.log($(this));
        e.preventDefault();

        $('#codebook-iframe').attr('src', this.id );
      }

      var parseInstrument = function(codebooks, target)
      {
        var raw_cb = {};
        var derived_cb = {};
        var annotated = {};
        var years = [];

        // patterns for matching
        var derived_pat = new RegExp(/_DER$/);
        var annotated_pat = new RegExp(/_ANNOTATED\.[pdf|doc|html]/);

        $.each( codebooks, function(key, this_codebook) {
          // console.log( key );
          // console.log( this_codebook );
          
          years.push(this_codebook.year);

          if ( derived_pat.test( this_codebook.instr ) ) {
            // console.log('we have a derived codebook');
            if( !derived_cb.hasOwnProperty(this_codebook.year) ) {
              derived_cb[this_codebook.year] = [];
            }
            derived_cb[this_codebook.year].push({
              "src" : "./instruments/" + this_codebook.instr + "_" + this_codebook.year + ".html", 
              "text" : this_codebook.title,
              "title" : "[Derived] " +this_codebook.subject
              });
          } else if ( annotated_pat.test( this_codebook.instr ) ) {
            // console.log('we have a annotated questionnaire');
            if( !annotated.hasOwnProperty(this_codebook.year) ) {
              annotated[this_codebook.year] = [];
            }
            var abbreviation = this_codebook.instr.match(/[a-zA-Z0-9]*_/);
            abbreviation = abbreviation[0].replace('_', '');
            annotated[this_codebook.year].push({
              "src" : "./annotated/" + this_codebook.year + "/" + this_codebook.instr,
              "text" : "[Annotated Survey] " + abbreviation,
              "title" : this_codebook.instr
            });
          } else {
            // console.log('we have a raw codebook');
            if( !raw_cb.hasOwnProperty(this_codebook.year) ) {
              raw_cb[this_codebook.year] = [];
            }
            raw_cb[this_codebook.year].push({
                                              "src" : "./instruments/" + this_codebook.instr + "_" + this_codebook.year + ".html",
                                              "text" : this_codebook.title,
                                              "title" : "[Raw] " + this_codebook.subject
                                            });
          }
        }); // end for each over cb

        var years_unique = $.grep( years, function(v, k) {
                             return $.inArray(v, years) === k;
                           });
        years_unique.sort()

         console.log(years_unique);
         console.log(raw_cb);
         console.log(derived_cb);
         console.log(annotated);


        $.each( years_unique, function(key, year) {

          // make the "header" for the years
          $(target).append(
            $('<div>').attr('href', '#')
                      .text(year)
                      .addClass('list-group-item')
                      .addClass('codebook-list-year-header')
          );

          // add the raw codebook link(s) if they exist
          var rr = $('<a>').attr('href', '#')
                           .text('[Raw Variables]')
                           .addClass('list-group-item')
                           .addClass('disabled')
                           ;
          if ( raw_cb.hasOwnProperty(year) ) {
            $.each( raw_cb[year], function(key, this_cb) {
              var rr = $('<a>').attr('href', '#');
              rr.text(this_cb.text);
              rr.attr('title', this_cb.title);
              rr.addClass('list-group-item');
              rr.addClass('codebook-list-item-link');
              rr.addClass('tooltip-right');
              rr.attr('id', this_cb.src);
              $(target).append(rr);
            });
          } else {
            $(target).append(rr); // attache the disabled link
          }
          

          // add the derived codebook link if it exists
          var dd = $('<a>').attr('href', '#')
                           .text('Derived Variables')
                           .addClass('list-group-item')
                           .addClass('disabled')
                           ;
          if ( derived_cb.hasOwnProperty(year) ) {
            $.each( derived_cb[year], function(key, this_cb) {
              var dd = $('<a>').attr('href', '#');
              dd.text(this_cb.text);
              dd.attr('title', this_cb.title);
              dd.addClass('list-group-item');
              dd.addClass('codebook-list-item-link');
              dd.addClass('tooltip-right');
              dd.attr('id', this_cb.src);
              $(target).append(dd);
            })
          } else {
            $(target).append(dd); // attache the disabled link
          }

          // add annotated questionnaire if it exists
          var aa = $('<a>').attr('href', '#')
                           .text('Annotated Survey')
                           .addClass('list-group-item')
                           .addClass('disabled')
                           ;
          if ( annotated.hasOwnProperty(year) ) {
            $.each( annotated[year], function(key, this_cb) {
              var aa = $('<a>').attr('href', '#');
              aa.text(this_cb.text);
              aa.attr('title', this_cb.title);
              aa.addClass('list-group-item');
              aa.addClass('codebook-list-item-link');
              aa.addClass('tooltip-right');
              aa.attr('id', this_cb.src);
              $(target).append(aa);
            })
          } else {
            $(target).append(dd); // attache the disabled link
          }
          //     $('<a>').attr('href', '#')
          //             //.attr('id', cb_year)
          //             .attr('class', 'codebook-list-item-link')
          //             .text(year)
          //             addClass('codebook-list-item').append(
          // ));
        }); // end of each years_unique
      }

      // on load 
      $.getJSON( 'codebook_menu.json' , function( instruments ) {
        // make the menu items
        $.each( instruments, function(key, value) {
          // // console.log( key );
          // // console.log( value );
          $('#instrument-list').append(
            $('<li>').addClass('instrument-list-item').append(
              $('<a>').attr('href', '#')
                      .attr('id', key)
                      .attr('data-codebooks', JSON.stringify(value))
                      .attr('class', 'instrument-list-item-link')
                      .text(key)
          ));
        });
      });

      // turn on tooltips
      $('.tooltip-right').tooltip({ placement: "right",
                                    delay: 500,
                                     })

      // load up dynamic listeners
      $('#instrument-list').on('click', '.instrument-list-item-link', instrumentClicked );
      $('#codebook-list').on('click', '.codebook-list-item-link', codebookClicked );

    }); // end document ready
  </script>
  </body>

</html>
